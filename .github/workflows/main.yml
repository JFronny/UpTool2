name: CD

on: [push]

jobs:
  build:

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v1
    - name: Build
      id: base_init
      run: |
        cd "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin\"
        .\MSBuild.exe $Env:GITHUB_WORKSPACE\UpTool2.sln -p:Configuration=Release -m
        cd "C:\Program Files\7-Zip\"
        .\7z a $Env:GITHUB_WORKSPACE\Release.zip $Env:GITHUB_WORKSPACE\UpTool2\bin\Release
        cd $Env:GITHUB_WORKSPACE\UpTool2\bin\Release
        $asmver = $([Reflection.Assembly]::Loadfile($(pwd).Path + "\\UpTool2.exe").GetName().version.ToString())
        cd $Env:GITHUB_WORKSPACE
        echo "::set-output name=vers::$asmver"
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1.0.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.base_init.outputs.vers }}
        release_name: Release ${{ steps.base_init.outputs.vers }}
        draft: false
        prerelease: false
    - name: Upload Release Asset
      id: upload_release_asset
      uses: actions/upload-release-asset@v1.0.1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./Release.zip
        asset_name: Release.zip
        asset_content_type: application/zip
    - name: Fix files
      id: final
      run: |
        echo "Cloning"
        git clone https://gist.github.com/JFronny/f1ccbba3d8a2f5862592bb29fdb612c4 MetaXML
        cd MetaXML
        echo "Building XML"
        $xml = New-Object XML
        $xml.load("Meta.xml")
        $xml.meta.Hash = $(Get-FileHash ..\Release.zip).Hash
        $xml.meta.Version = ${{ steps.base_init.outputs.vers }}
        $xml.meta.File = "${{ steps.upload_release_asset.outputs.browser_download_url }}"
        $xml.save("Meta.xml")
        echo "Removing UTF-8 BOM"
        $FilePath=$(pwd).Path + "\Meta.xml"
        [System.IO.FileInfo] $file = Get-Item -Path $FilePath
        $sequenceBOM = New-Object System.Byte[] 3
        $reader = $file.OpenRead()
        $bytesRead = $reader.Read($sequenceBOM, 0, 3)
        $reader.Dispose()
        if ($bytesRead -eq 3 -and $sequenceBOM[0] -eq 239 -and $sequenceBOM[1] -eq 187 -and $sequenceBOM[2] -eq 191)
        {
            $utf8NoBomEncoding = New-Object System.Text.UTF8Encoding($False)
            [System.IO.File]::WriteAllLines($FilePath, (Get-Content $FilePath), $utf8NoBomEncoding)
            Write-Host "Remove UTF-8 BOM successfully"
        }
        echo "Pushing"
        echo "Adding"
        git add .
        echo "Committing"
        git commit -m "Automated update to Meta.xml"
        git push
